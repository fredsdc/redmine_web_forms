<h2><%= @webform.title %></h2>

<% if @webform.description.present? %>
  <div class="wiki">
    <%= textilizable @webform.description %>
  </div>
<% end %>

<% values=@issue.editable_custom_field_values.group_by{|x| x.custom_field_id} %>
<%= labelled_form_for @issue, :url => { :action => "new_issue" } do |f| %>
  <%= error_messages_for 'webform' %>

  <% @webform.questions.sorted.each do |q| %>
    <% if q.custom_field.present? || [-1,-2,-3].include?(q.custom_field_id) %>
      <div class="box tabular">
        <p><%= q.description %></p>
        <% if q.custom_field_id == -1 %>
          <p><%= f.select :assigned_to_id, principals_options_for_select(@issue.assignable_users, @issue.assigned_to),
                          :include_blank => true, :label => "", :required => @issue.required_attribute?('assigned_to_id') %></p>
        <% elsif q.custom_field_id == -2 %>
          <p><%= f.select :category_id, (@issue.project.issue_categories.collect {|c| [c.name, c.id]}),
                          {:include_blank => true, :label => "", :required => @issue.required_attribute?('category_id')} %></p>

        <% elsif q.custom_field_id == -3 %>
          <p><%= f.text_area :description, :cols => 60, :accesskey => accesskey(:edit), :class => 'wiki-edit',
                             :rows => [[10, @issue.description.to_s.length / 50].max, 20].min,
                             :data => {
                               :auto_complete => true,
                               :issues_url => auto_complete_issues_path(:project_id => @issue.project, :q => '')
                             },
                             :no_label => true %></p>
          <%= wikitoolbar_for 'issue_description', preview_issue_path(:project_id => @issue.project, :issue_id => @issue.id) %>
        <% else %>
          <p><%= custom_field_tag :issue, values[q.custom_field_id][0] if q.custom_field.present? %></p>
          <%= wikitoolbar_for "issue_custom_field_values_#{q.custom_field_id}" if q.custom_field.present? && q.custom_field.full_text_formatting? %>
        <% end %>
      </div>
    <% end %>
  <% end %>
  <%= submit_tag l(:button_save) %>
<% end %>
