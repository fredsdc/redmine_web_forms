<h2><%= @webform.title %></h2>

<%= error_messages_for 'webform' %>
<%= error_messages_for 'issue' %>

<% if @webform.description.present? %>
  <div class="wiki">
    <%= textilizable @webform.description %>
  </div>
<% end %>

<% values=@issue.custom_field_values.map{|x| [x.custom_field.id, x]}.to_h %>
<%= labelled_form_for @issue, :url => { :action => "new_issue" } do |f| %>

  <% @webform.webform_custom_field_values.each do |w| %>
    <% if w.custom_field.present? || [-1,-2,-3,-4,-5].include?(w.custom_field_id) %>
      <% if w.custom_field_id == -1 && @issue.safe_attribute?('assigned_to_id') %>
        <%= f.hidden_field :assign_to_id, {:value => w.default_value, :id => w.identifier} %>
      <% elsif w.custom_field_id == -2 && @issue.safe_attribute?('category_id') %>
        <%= f.hidden_field :category_id, {:value => w.default_value, :id => w.identifier} %>
      <% elsif w.custom_field_id == -3 && @issue.safe_attribute?('description') %>
        <%= f.hidden_field :description, {:value => w.default_value, :id => w.identifier} %>
      <% elsif w.custom_field_id == -4 %>
        <%= f.hidden_field :subject, {:value => w.default_value, :id => w.identifier} %>
      <% elsif w.custom_field_id == -5 && @issue.safe_attribute?('fixed_version_id') %>
        <%= f.hidden_field :fixed_version_id, {:value => w.default_value, :id => w.identifier} %>
      <% elsif @issue.safe_attribute? 'custom_field_values'  %>
        <%= hidden_field_tag "issue[custom_field_values][#{w.custom_field_id}]", w.default_value, { :id => w.identifier } if w.custom_field.present? %>
      <% end %>
    <% else %>
      <%= hidden_field_tag '', w.default_value, { :id => w.identifier } %>
    <% end %>
  <% end %>

  <% @webform.questions.each do |q| %>
    <div class="box" <%= q.hidden? ? 'style="display: none;"'.html_safe : '' %>>
      <% if q.custom_field.present? || [-1,-2,-3,-4,-5].include?(q.custom_field_id) %>
        <% if q.custom_field_id == -1 && @issue.safe_attribute?('assigned_to_id') %>
          <p><%= q.description %></p>
          <p><%= f.select :assigned_to_id, principals_options_for_select(@issue.assignable_users, @issue.assigned_to),
                          {:include_blank => true, :label => "", :required => @issue.required_attribute?('assigned_to_id')},
                          {:id => q.identifier, :onchange => q.onchange} %></p>
        <% elsif q.custom_field_id == -2 && @issue.safe_attribute?('category_id') %>
          <p><%= q.description %></p>
          <p><%= f.select :category_id, (@issue.project.issue_categories.collect {|c| [c.name, c.id]}),
                          {:include_blank => true, :label => "", :required => @issue.required_attribute?('category_id')},
                          {:id => q.identifier, :onchange => q.onchange} %></p>
        <% elsif q.custom_field_id == -3 && @issue.safe_attribute?('description') %>
          <p><%= q.description %></p>
          <p><%= f.text_area :description, :cols => 60, :accesskey => accesskey(:edit), :class => 'wiki-edit',
                             :rows => [[10, @issue.description.to_s.length / 50].max, 20].min,
                             :no_label => true, :id => q.identifier, :onchange => q.onchange %></p>
          <%= wikitoolbar_for 'issue_description', preview_issue_path(:project_id => @issue.project, :issue_id => @issue.id) %>
        <% elsif q.custom_field_id == -4 %>
          <p><%= q.description %></p>
          <p><%= f.text_field :subject, :size => 80, :maxlength => 255, :label => "", :id => q.identifier,
                              :required => true, :onchange => q.onchange %></p>
        <% elsif q.custom_field_id == -5 && @issue.safe_attribute?('fixed_version_id') %>
          <p><%= q.description %></p>
          <p><%= f.select :fixed_version_id, (@issue.project.versions.collect{|c| [c.name, c.id]}),
                          {:no_label => true, :include_blank => true}, {:id => q.identifier, :onchange => q.onchange} %></p>
        <% elsif @issue.safe_attribute? 'custom_field_values' %>
          <p><%= q.description %></p>
          <% id = q.identifier.present? ? q.identifier : custom_field_tag_id(:issue, q.custom_field) %>
          <p><%= custom_field_tag(:issue, values[q.custom_field_id]).
            gsub(/ id="(.+?)"/, ' id="' + id + '" onchange="' + q.onchange + '"' ).html_safe if q.custom_field.present? %></p>
          <%= wikitoolbar_for id if q.custom_field.present? && q.custom_field.full_text_formatting? %>
        <% end %>
      <% elsif (q.custom_field_id.nil?) %>
        <p><%= q.description %></p>
        <% if q.possible_values.present? %>
          <p><%= select_tag '', options_for_select(q.possible_values), :id => q.identifier, :onchange => q.onchange, :include_blank => true %></p>
        <% else %>
          <p><%= text_area_tag '', '', :id => q.identifier, :onchange => q.onchange, :cols => 60, :class => 'wiki-edit', :rows => 3 %></p>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <%= submit_tag l(:button_save) %>
<% end %>
